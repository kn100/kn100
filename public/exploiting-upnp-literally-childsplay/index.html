<!DOCTYPE html>
<html lang="en-gb">

<head>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-116596166-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-116596166-1');
</script>

<meta charset="utf-8" />
<meta name="author" content="" />
<meta name="description" content="Kevin Norman - or kn100 - a software engineer from London who likes to play about with embedded systems and sometimes blog about it. You&#39;ll find me playing around with Arduino, ESP32, Linux, and more. " />
<meta name="keywords" content="kn100, tech, golang, redis, software engineering, computer science" />
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="generator" content="Hugo 0.80.0" />

<link rel="canonical" href="https://kn100.me/exploiting-upnp-literally-childsplay/">
<meta property="og:title" content="Exploiting UPnP, Literally Childsplay." />
<meta property="og:description" content="Universal Plug and Play is an interesting standard. This is the story of how I exploited a design flaw in uPnP without even realizing it as a child." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kn100.me/exploiting-upnp-literally-childsplay/" />
<meta property="article:published_time" content="2019-07-05T14:20:41+00:00" />
<meta property="article:modified_time" content="2019-07-05T14:20:41+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Exploiting UPnP, Literally Childsplay."/>
<meta name="twitter:description" content="Universal Plug and Play is an interesting standard. This is the story of how I exploited a design flaw in uPnP without even realizing it as a child."/>


<meta itemprop="name" content="Exploiting UPnP, Literally Childsplay.">
<meta itemprop="description" content="Universal Plug and Play is an interesting standard. This is the story of how I exploited a design flaw in uPnP without even realizing it as a child.">
<meta itemprop="datePublished" content="2019-07-05T14:20:41+00:00" />
<meta itemprop="dateModified" content="2019-07-05T14:20:41+00:00" />
<meta itemprop="wordCount" content="1522">



<meta itemprop="keywords" content="Nostalgia,Funny,Security,Stories," />


<link rel="stylesheet" href="/css/layout.css" />
<style type="text/css">
body {
  background-color: #FFFFFF;
  color: #000000;
}

a { color: #000000; }

pre {
  background: #EEEEEE;
  border: 1px solid #000000;
  border-radius: 5px;
}

code {
  background-color: transparent;
}

blockquote {
  background: #EEEEEE;
  border-left: 3px solid #000000;
}

table {
  margin: 1em auto;
  border-collapse: collapse;
}

table, th, td {
  border: 1px solid #000000;
}

th {
  background: #000000;
  color: #FFFFFF;
}

.siteTitle a { color: #0d5a91; }

.post .content h1{ color: #0d5a91; }
.post .content h2{ color: #0d5a91; }
.post .content h3{ color: #0d5a91; }
.post .content h4{ color: #0d5a91; }
.post .content h5{ color: #0d5a91; }
.post .content h6{ color: #0d5a91; }
.post .content a:hover { color: #0d5a91; }
.social-link:hover { color: #0d5a91; }
.nav-item-title:hover { color: #0d5a91; }
.tag a:hover { color: #0d5a91; }
.copyright { color: #404040 }
.poweredby { color: #404040 }
.poweredby a { color: #404040; }
.post-preview .title a{ color: #0d5a91; }
.content-item a:hover{
  text-decoration: underline;
  color: #0d5a91;
}
.post-list .title { color: #0d5a91; }
.rmore { color: #000000; }
.rmore:hover { color: #0d5a91; }
.terms .term a:hover {
  text-decoration: underline;
  color: #0d5a91;
}

</style>



<title>


     Exploiting UPnP, Literally Childsplay. 

</title>
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
</head>


<body>
<div class="main">
<header>

<div class="header-bar">

  <nav>
    <div class="siteTitle">
      <a href="https://kn100.me/">
        <img class="logo" src="/nulogo.png" alt="KN100 | Kevin Norman">
      </a>
    </div> 

    
    
    <a class="nav-item" href="/about/"><div class="nav-item-title">About me</div></a>
    
    <a class="nav-item" href="/tags/"><div class="nav-item-title">Tags</div></a>
    
  </nav>
</div>

  
<div class="social-links-header">

  
  <a href="mailto:kn100&#43;blog@kn100.me"><div class="social-link">Email</div></a>
  

  
  <a href="https://github.com/kn100" target="_blank"><div class="social-link">GitHub</div></a>
  

  

  
  <a href="https://twitter.com/@normankev141" target="_blank"><div class="social-link">Twitter</div></a>
  

  
  <a href="https://www.linkedin.com/in/kevin-norman" target="_blank"><div class="social-link">LinkedIn</div></a>
  

</div>
 

</header>


<article class="post">
    <h1 class="title"> Exploiting UPnP, Literally Childsplay. </h1>
    <div class="content"> <p>As a kid, I used to love playing Minecraft. I was technically precocious from a fairly young age, and naturally gravitated to attempting to host my own Minecraft server for me and my band of geeky pals to play on. The problem was, I had no idea what port forwarding was, nor how to log into a router. The solution I found was about as novel as it was dumb.</p>
<p>I tried a few different things initially. I firstly tried hosting a Minecraft server on a few different &lsquo;free&rsquo; VPS suppliers. Immediately, the lack of RAM was an issue, creating unplayable lag spikes that took the fun out of it. It took me a while to realise that there was no free lunch, and nobody was going to host my ridiculously resource hungry Java based server in a way that would be beneficial to me. Gigabytes of RAM were expensive.</p>
<p>Next, I tried hosting it locally, but kept hitting up against a concept my young brain knew nothing about - which was port forwarding. I knew it required access to the Router, but that was guarded by my father, who was understandably and correctly worried about letting his son mess about in settings that he himself also did not really understand.</p>
<figure>
    <img src="/images/upnp-router.jpeg"
         alt="Netgear DG834GT - The router provisioned to my family by Freeserve (remember them?!)"/> <figcaption>
            <p>Netgear DG834GT - The router provisioned to my family by Freeserve (remember them?!)</p>
        </figcaption>
</figure>

<p>Furious, rushed Google led me to Hamachi. Hamachi, now owned by LogMeIn is a hosted VPN service. Effectively it puts you and your friends who want to play on a VPN together. This worked a little better than my previous attempts, but still introduced a lot of latency, and as such wasn&rsquo;t ideal. I stuck with this for a little while, but there had to be a better way.</p>
<p>The only other time I&rsquo;d ever come across port forwarding was in my use of Bittorrent. Supposedly, without an open port, Bittorrent couldn&rsquo;t function correctly. How did it function correctly then, I wondered? My client of choice (Transmission) would dutifully tell me whichever port I selected was &lsquo;open&rsquo;. Were all the ports open? Was my Minecraft server lying to me? After all, Transmission seemed to work perfectly downloading and even seeding things. I regularly used Bittorrent for distributing files between my few PCs and friends at the time, and it seemed to work perfectly.</p>
<figure>
    <img src="/images/upnp-transmission.png"
         alt="No matter the Listening Port number - Test Port reported open!"/> <figcaption>
            <p>No matter the Listening Port number - Test Port reported open!</p>
        </figcaption>
</figure>

<p>It didn&rsquo;t seem to matter which port I selected, when I pressed that &ldquo;Test Port&rdquo; button, somehow it was open! This wasn&rsquo;t fair! How come the router stazi allowed Transmission to talk to whoever it wanted to, whenever it wished, yet my poor Minecraft server received no such special treatment? Was Big Torrent bribing Netgear? What sort of nepotism was this?!</p>
<p>UPNP meant nothing to me, and I didn&rsquo;t think to Google it at the time, but it was the technology that allowed Transmission to talk to whoever it wanted.</p>
<p>One day, almost by accident, I found a solution. It turned out that if I opened the Minecraft Server first, then entered the port that it was configured to use into the Port box within Transmission, and then hit Test Port, and left Transmission open while me and my friends would waste hours building things I&rsquo;d eventually <em>accidentally</em> blow up with TNT, it just seemed to work!</p>
<p>What I didn&rsquo;t realise back then was I was taking advantage of a security flaw within UPNP. Even though I was innocently hijacking the port Transmission opened for use with Minecraft, I was actually exploiting a fairly serious security vulnerability in the protocol. UPNP allows any old software to punch a hole through your routers firewall. It doesn&rsquo;t verify <strong>which</strong> software is making use of said port. Any old code running on your computer is able to do this, including most terrifyingly to me at the time I realised what I was doing the hugely popular <a href="https://www.gnucitizen.org/blog/flash-upnp-attack-faq/">Adobe Flash</a>.</p>
<h1 id="how-upnp-works">How UPnP works</h1>
<p>UPnP is a complicated standard whose overarching goal is to allow devices on a network to discover one anothers presence without require configuration from the user. It seems to want to abstract over various network configurations to reduce the mental burden of the user using a product which supports it. A noble goal. Far too much to talk about here! Instead I will focus on one part of UPnP, which is how it allows devices inside your network to punch holes through your routers firewall (port forward).</p>
<p>UPnP makes use of Internet Gateway Device Protocol, which is a protocol for mapping ports where NAT (Network Address Translation) is in use. Effectively it allows devices on a network to communicate their requests for a router to route data hitting a particular port to a the system making the request. IGDP also allows applications to learn the external IP address without having to use an external system, and even see which port mappings already exist. Crazily, there is even provision for the standard to allow applications on your network to request the router get a new public IP address, however I&rsquo;ve personally never seen this in use.</p>
<p>When an application, for example Transmission, wants to map a port for its use, it makes a request to what the RFC for this refers to as the IGD Control point (in most cases the router).</p>
<p>After this, and if authentication is either not enabled or passes (it is not enabled in most cases!) - the IGD sends a &ldquo;AddAnyPortMapping()&rdquo; request through to the Internet Gateway Device - Port Control Protocol Interworking Function, or the IGD-PCP IWF for short. Oh aren&rsquo;t RFCs fun! The IGD-PCP IWF then makes a Port Control Protocol MAP request to the PCP server.</p>
<p>The PCP Server can then do one of three broad categories of things:</p>
<ul>
<li>It can refuse. It may refuse because the port has already been opened for someone else. It may refuse for other reasons too.</li>
<li>It can accept, and return a PCP MAP Response with the assigned external port the UPnP Control Point requested</li>
<li>It can accept, and return a PCP MAP Response with another external port that the UPnP Control Point did not request but it can use if it wishes.</li>
</ul>
<p>The application that triggered this whole flow may then test that the port mapping worked - usually by using some external api to attempt to GET something running on that port on the machine running the software. Voila, the port is open. The software can then request that the mapping it made be deleted. So can anyone else who can make requests to the IGD. The Software then effectively has a lease over this port, and the port will remain open until its lease expires, or the software deletes it manually. The maximum length of a lease is configurable by the IGD, but the max defined in the spec is 4294967296 seconds - a ridiculously high max.</p>
<p>The only other case where the lease will be terminated is when the IP that generated it is no longer around. If the machine shuts down or its DHCP lease over its own IP expires, the spec assumes the port mappings associated with it are lost too. <a href="http://www.upnp-hacks.org/annoyances.html">This is not always the case though.</a></p>
<p>The RFC states that &ldquo;we assume that the IGD applies the appropriate security policies to determine whether a Control Point has the rights to delete one or a set of mappings&rdquo;. This is not an unreasonable assumption; after all, routers come in all shapes and sizes, and the authentication mechanisms they rely on come in various shapes and sizes too. It has become obvious with time though that due to the nature of the consumer hardware industry, security is an afterthought, if a thought at all. Indeed, a rather hilarious but sad security exploit <a href="https://blogs.akamai.com/sitr/2018/11/upnproxy-eternalsilence.html">reported by Akamai</a> found that around 3.5 million routers scanned responded to UPnP probe packets. This means that external parties can punch holes through the firewall by sending UPnP requests to it. Even worse, around 277,000 of these routers actually don&rsquo;t verify that the software making the request is port forwarding to itself! In fact, the RFC mandates this. If routers were to ensure that port mappings being requested by a source were to point at that source, they&rsquo;d not be in compliant with RFC 6970!</p>
<p>This means that previously inaccessible hosts within a network can now be reached by attackers spamming the routers with UPnP port forward requests - effectively opening the machines behind the firewall to the open internet. Terrifying stuff.</p>
<p>It gets worse though. Some of these routers routers don&rsquo;t do this origin check, and in addition they don&rsquo;t even check that the port mapping points to a <strong>machine that exists on the local network.</strong> Essentially this means that any one of these routers can be hacked to become a sort of proxy. How? By asking it to, of course.</p>
<p>This is why I now disable UPNP everywhere I have the power to. It&rsquo;s one of those convenient yet terrifying technologies I am not sure I can trust. Sometimes free convenience is far more expensive than anybody realizes. <a href="https://arstechnica.com/information-technology/2018/11/mass-router-hack-exposes-millions-of-devices-to-potent-nsa-exploit/">Just ask the NSA.</a></p>
 </div>
    <footer class="post-footer">
  <hr/>
  <p> <b>Enjoyed this blog post?</b> Check out some of my other writing:</p>
  <ul>
    <li><a href="/usb-hub-bs">Why doesn't my computer boot with a USB Hub connected?</a></li>
    <li><a href="/making-breaking-changes-in-go">How to make breaking changes in Golang</a></li>
    <li><a href="/those-damn-romanians">Those damn romanians</a></li>
    <li><a href="/redis-pipelining"> Beating Round-Trip Latency With Redis Pipelining </a></li>
    <li><a href="/where-embedded-meets-the-internet-building-your-own-air-quality-meter">Use the ESP32 and BME680 to build your own Air Quality Meter</a></li>
    <li><a href="/the-accidental-domain-squatter">Why suspect us?</a></li>
    <li><a href="/exploiting-upnp-literally-childsplay">UPNP is insecure</a></li>
    <li><a href="/">Or check out all of my writing</a></li>
  </ul>

  <p><b>Or, let me know what you thought!</b> Tweet me at <a href="https://twitter.com/normankev141">@normankev141</a> - I'd appreciate it!</p>
  <div class="post-footer-data">
    
<div class="tags">
    
      <div class="tag">
        <a href="/tags/nostalgia">#Nostalgia</a>
      </div>
    
      <div class="tag">
        <a href="/tags/funny">#Funny</a>
      </div>
    
      <div class="tag">
        <a href="/tags/security">#Security</a>
      </div>
    
      <div class="tag">
        <a href="/tags/stories">#Stories</a>
      </div>
    
</div>

    <div class="date"> 5 Jul 2019 </div>
  </div>
<a href="#">Back to top</a>
</footer>


  


</article>

  <footer>

  <div class="social-links-footer">

  
  <a href="mailto:kn100&#43;blog@kn100.me"><div class="social-link">Email</div></a>
  

  
  <a href="https://github.com/kn100" target="_blank"><div class="social-link">GitHub</div></a>
  

  

  
  <a href="https://twitter.com/@normankev141" target="_blank"><div class="social-link">Twitter</div></a>
  

  
  <a href="https://www.linkedin.com/in/kevin-norman" target="_blank"><div class="social-link">LinkedIn</div></a>
  

  <div class="social-link">
  <a href="https://kn100.me/index.xml" target="_blank">RSS</a>
  </div>

</div>


  <div class="copyright">  </div>

  </footer>

</div> 

</body>
</html>

